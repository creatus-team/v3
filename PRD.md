# Rapid Coaching Control Center (RCCC)
## 기획 문서 v3.13 (Final)

---

# 📌 1. 이 프로젝트가 뭔가요?

## 1.1 한 줄 요약

**코칭 수업 관리를 엑셀 대신 웹사이트에서 편하게 하는 관리자용 시스템**

## 1.2 왜 만드나요?

현재 문제점:
- 결제 데이터가 구글 시트에만 쌓여서 관리가 어려움
- 코치별로 누가 수업 중인지 한눈에 안 보임
- 취소/환불 시 수동으로 여러 곳을 수정해야 함
- 문자 발송이 잘 됐는지 확인이 어려움

해결책:
- 모든 데이터를 한 곳(웹사이트)에서 관리
- 자동으로 계산하고 알림 보내주는 시스템 구축

## 1.3 핵심 원칙

| 원칙 | 쉬운 설명 |
|------|-----------|
| **데이터 절대 안 잃어버림** | 잘못된 데이터라도 일단 저장하고 나중에 수정 |
| **자동화** | 취소하면 자동으로 슬롯이 비워지고, 날짜가 계산됨 |
| **한 곳에서 다 보기** | 여러 시트 왔다갔다 안 해도 됨 |
| **관리자가 최종 결정** | 시스템이 자동 계산하지만, 관리자가 수정 가능 |
| **실수 방지** | 위험한 동작은 확인창으로 한 번 더 체크 |
| **멱등성 보장** | 같은 데이터가 여러 번 와도 한 번만 처리 |

## 1.4 운영 규모

| 항목 | 현재 | 1차 확장 | 2차 확장 |
|------|------|----------|----------|
| 코치 수 | 3명 | 20명 | 점진적 증가 |
| 월간 수강생 | 16명 | 60명 | 100명+ |

---

# 📌 2. 사용할 기술들

> 💡 개발자가 알아야 할 내용입니다. 모르셔도 괜찮아요!

| 뭐에 쓰는 건가요? | 기술 이름 |
|-------------------|-----------|
| 웹사이트 만들기 | Next.js 14+ |
| 프로그래밍 언어 | TypeScript |
| 데이터 저장소 (DB) | Supabase |
| 디자인 | Tailwind CSS + Shadcn/UI |
| 표 만들기 | Tanstack Table |
| 문자 발송 | Solapi |
| 엑셀 연동 | Google Apps Script |
| 결제 플랫폼 | Latpeed |
| 서버 배포 | Vercel |
| **날짜 처리** | **dayjs + timezone 플러그인** |

---

# 📌 3. 코드 작성 원칙

> 💡 개발자가 지켜야 할 규칙입니다.

## 3.1 상수(Constants) 관리

**규칙**: `status`, `action_type`, `grade` 등 정해진 값들은 코드에 직접 쓰지 않고, `constants.ts` 파일 하나에 모아서 관리한다.

**왜?**: 오타로 인한 버그를 막기 위해

**나쁜 예시** ❌:
```typescript
// 여기저기서 문자열을 직접 사용
if (session.status === 'ACTIVE') { ... }
if (session.status === 'active') { ... }  // 오타! 버그 발생
```

**좋은 예시** ✅:
```typescript
// constants.ts 파일에 한 번만 정의
export const SESSION_STATUS = {
  PENDING: 'PENDING',
  ACTIVE: 'ACTIVE',
  EXPIRED: 'EXPIRED',
  CANCELLED: 'CANCELLED',
  REFUNDED: 'REFUNDED',
} as const;

// 다른 파일에서 가져다 쓰기
import { SESSION_STATUS } from '@/lib/constants';
if (session.status === SESSION_STATUS.ACTIVE) { ... }
```

---

## 3.2 Next.js 캐싱 끄기 ⚠️ 중요

> 🚨 **이 규칙을 어기면 DB가 업데이트되어도 화면에 옛날 데이터가 보입니다!**

### 문제 상황

Next.js 14 App Router는 기본적으로 **강력한 캐싱**을 합니다.

**버그 예시:**
```
1. 홍길동이 결제함 → DB에 저장됨
2. 관리자가 대시보드 새로고침
3. 여전히 옛날 데이터가 보임 ❌
4. Next.js가 "아까 만든 페이지 보여줘야지~" 하고 캐시된 걸 보여줌
```

### 해결책: 모든 페이지/API에 캐시 끄기

**규칙:**
1. 모든 `page.tsx` 파일 상단에 추가
2. 모든 `route.ts` (API) 파일 상단에 추가

```typescript
// app/page.tsx, app/coaches/page.tsx 등 모든 페이지
export const dynamic = 'force-dynamic';
export const revalidate = 0;
```

```typescript
// app/api/*/route.ts 모든 API
export const dynamic = 'force-dynamic';
```

**fetch 사용 시에도 캐시 끄기:**
```typescript
// ❌ 나쁜 예시 - 캐시됨
const res = await fetch('/api/sessions');

// ✅ 좋은 예시 - 캐시 안 됨
const res = await fetch('/api/sessions', { cache: 'no-store' });
```

---

## 3.3 에러 격리 (Error Isolation) ⚠️ 중요

> 🚨 **이 규칙을 어기면 문자 발송 실패가 전체 시스템을 죽입니다!**

### 문제 상황

**버그 예시:**
```
1. Raw 저장 완료 ✅
2. 파싱 완료 ✅
3. DB 저장 완료 ✅
4. 문자 발송 중... Solapi 서버 느림... 10초...
5. Vercel이 강제 종료 💀
6. 구글 시트는 "실패"로 인식 → 재전송 → 중복 처리?
```

### 해결책: 문자 발송은 try-catch로 격리

**규칙:** 문자 발송이 실패해도 전체 프로세스는 성공으로 처리

```typescript
// ❌ 나쁜 예시 - 문자 실패하면 전체가 죽음
export async function POST(req: Request) {
  await saveRawData(data);
  await parseAndSave(data);
  await sendSms(phone, message);  // 여기서 에러나면 전체 실패
  return Response.json({ success: true });
}

// ✅ 좋은 예시 - 문자 실패해도 계속 진행
export async function POST(req: Request) {
  await saveRawData(data);
  await parseAndSave(data);
  
  // 문자 발송은 격리
  try {
    await sendSmsWithTimeout(phone, message, 4000); // 4초 제한
  } catch (e) {
    // 실패해도 로그만 남기고 계속 진행
    await logSmsFailure(phone, message, e);
  }
  
  // 문자 성공/실패 상관없이 성공 응답
  return Response.json({ success: true });
}
```

### 타임아웃 유틸리티

```typescript
// lib/utils/timeout.ts
export async function withTimeout<T>(
  promise: Promise<T>,
  ms: number
): Promise<T> {
  const timeout = new Promise<never>((_, reject) =>
    setTimeout(() => reject(new Error('Timeout')), ms)
  );
  return Promise.race([promise, timeout]);
}

// 사용 예시
await withTimeout(sendSms(phone, message), 4000);
```

---

## 3.4 타임존(Timezone) 규칙 ⚠️ 중요

> 🚨 **이 규칙을 어기면 날짜 계산이 하루씩 밀리는 버그가 발생합니다!**

### 문제 상황

Vercel 서버는 기본적으로 **UTC(세계협정시)** 기준입니다. 한국은 **UTC+9**입니다.

**버그 예시:**
```
한국 시간: 월요일 새벽 1시에 결제 (화요일 반 신청)
서버 인식: 일요일 오후 4시 (UTC)

"다음 주 화요일" 계산:
- 한국 기준: 내일모레 화요일 ✅
- UTC 기준: 이번 주 화요일 ❌ (일주일 빠름!)
```

### 해결책: 모든 날짜는 KST(Asia/Seoul) 기준

**규칙:**
1. **모든 날짜/시간 계산**은 반드시 `Asia/Seoul` 타임존 적용
2. **JavaScript 기본 Date 사용 금지** → `dayjs` 사용
3. 프로젝트 전체에서 아래 설정된 `dayjs`만 import해서 사용

### dayjs 설정 코드

```typescript
// lib/dayjs.ts
import dayjs from 'dayjs';
import timezone from 'dayjs/plugin/timezone';
import utc from 'dayjs/plugin/utc';
import 'dayjs/locale/ko';

dayjs.extend(utc);
dayjs.extend(timezone);
dayjs.tz.setDefault('Asia/Seoul');
dayjs.locale('ko');

export default dayjs;
```

### 사용 예시

```typescript
// ❌ 나쁜 예시 - 절대 금지
import dayjs from 'dayjs';  // 기본 dayjs 직접 import
const today = new Date();   // JavaScript Date 직접 사용
const now = dayjs();        // 타임존 미적용

// ✅ 좋은 예시 - 이렇게만 사용
import dayjs from '@/lib/dayjs';  // 설정된 dayjs import
const today = dayjs();            // 자동으로 KST 적용
const nextTuesday = dayjs().day(9);  // 다음 주 화요일 (KST 기준)
```

### 날짜 저장/조회 규칙

| 상황 | 규칙 |
|------|------|
| DB 저장 | `DATE` 타입 (시간 없이 날짜만, 예: 2025-01-20) |
| DB 조회 후 표시 | KST 기준으로 포맷팅 |
| "오늘" 판단 | `dayjs().tz('Asia/Seoul')` 기준 |
| 크론잡 실행 시간 | KST 기준으로 설정 (예: 0시 5분 KST) |

---

## 3.5 constants.ts 파일 내용

```typescript
// lib/constants.ts

// ===== 타임존 =====
export const TIMEZONE = 'Asia/Seoul';

// ===== 세션(수강) 상태 =====
export const SESSION_STATUS = {
  PENDING: 'PENDING',              // 대기
  ACTIVE: 'ACTIVE',                // 수강중
  EXPIRED: 'EXPIRED',              // 종료 (정상 만료)
  CANCELLED: 'CANCELLED',          // 취소 (관리자 취소)
  REFUNDED: 'REFUNDED',            // 환불 (Latpeed 환불)
  EARLY_TERMINATED: 'EARLY_TERMINATED',  // 조기종료 (환불 등)
} as const;

// ===== 결제 상태 (시트에서 들어오는 값) =====
export const PAYMENT_STATUS = {
  COMPLETED: '결제 완료',   // 정상 결제 (또는 빈 값)
  CANCELLED: '결제 취소',   // 환불/취소
} as const;

// ===== 수강생 상태 =====
// ⚠️ 삭제됨: 수강생 상태는 세션 상태로 자동 판단
// - ACTIVE 세션 있음 → 수강중
// - PENDING만 있음 → 대기
// - 전부 EXPIRED → 종료
// - 최근 REFUNDED → 환불
// - 최근 CANCELLED → 취소

// ===== 코치 등급 =====
export const COACH_GRADE = {
  TRAINEE: 'TRAINEE',      // 견습
  REGULAR: 'REGULAR',      // 정식 (일반)
  SENIOR: 'SENIOR',        // 선임
} as const;

// ===== 코치 등급별 정산 설정 =====
export const COACH_SETTLEMENT = {
  TRAINEE: { 
    packagePrice: 400000,   // 4회 패키지 40만원
    revenuePerSession: 100000,  // 1회당 매출: 10만원
    coachRatio: 0.4,        // 코치 40%, 회사 60%
    perSession: 40000,      // 1회당 코치 정산: 4만원
    companyPerSession: 60000,   // 1회당 회사 수익: 6만원
  },
  REGULAR: { 
    packagePrice: 400000,   // 4회 패키지 40만원
    revenuePerSession: 100000,  // 1회당 매출: 10만원
    coachRatio: 0.5,        // 코치 50%, 회사 50%
    perSession: 50000,      // 1회당 코치 정산: 5만원
    companyPerSession: 50000,   // 1회당 회사 수익: 5만원
  },
  SENIOR: { 
    packagePrice: 500000,   // 4회 패키지 50만원
    revenuePerSession: 125000,  // 1회당 매출: 12.5만원
    coachRatio: 0.6,        // 코치 60%, 회사 40%
    perSession: 75000,      // 1회당 코치 정산: 7.5만원
    companyPerSession: 50000,   // 1회당 회사 수익: 5만원
  },
} as const;

// ===== 활동 로그 타입 =====
export const ACTION_TYPE = {
  ENROLL: 'ENROLL',                    // 신규 등록
  RENEWAL: 'RENEWAL',                  // 재결제
  CANCEL: 'CANCEL',                    // 취소
  REFUND: 'REFUND',                    // 환불
  POSTPONE: 'POSTPONE',                // 수강 연기
  EARLY_TERMINATE: 'EARLY_TERMINATE',  // 조기종료 (환불로 인한)
  EDIT: 'EDIT',                        // 정보 수정
  SLOT_TIME_CHANGE: 'SLOT_TIME_CHANGE', // 슬롯 시간 변경
  USER_MERGE: 'USER_MERGE',            // 수강생 병합
} as const;

// ===== 조기종료 사유 =====
export const EARLY_TERMINATION_REASON = {
  REFUND: 'REFUND',            // 환불
  OTHER: 'OTHER',              // 기타
} as const;

// ===== 수동등록 사유 =====
export const MANUAL_ENTRY_REASON = {
  CASH_PAYMENT: 'CASH_PAYMENT',    // 현금/계좌이체
  FREE_TRIAL: 'FREE_TRIAL',        // 무료 체험
  TEST: 'TEST',                    // 테스트
  SYSTEM_RECOVERY: 'SYSTEM_RECOVERY',  // 시스템 오류 복구
  OTHER: 'OTHER',                  // 기타
} as const;

// ===== 시스템 로그 이벤트 타입 =====
export const EVENT_TYPE = {
  WEBHOOK_RECEIVED: 'WEBHOOK_RECEIVED',
  WEBHOOK_FAILED: 'WEBHOOK_FAILED',
  WEBHOOK_DUPLICATE: 'WEBHOOK_DUPLICATE',  // 중복 웹훅 감지
  PARSE_SUCCESS: 'PARSE_SUCCESS',
  PARSE_FAILED: 'PARSE_FAILED',
  SMS_SENT: 'SMS_SENT',
  SMS_FAILED: 'SMS_FAILED',
  SESSION_CREATED: 'SESSION_CREATED',
  SESSION_CANCELLED: 'SESSION_CANCELLED',
  SESSION_REFUNDED: 'SESSION_REFUNDED',
  SLOT_CONFLICT: 'SLOT_CONFLICT',
  REFUND_AUTO_PROCESSED: 'REFUND_AUTO_PROCESSED',
  REFUND_MATCH_FAILED: 'REFUND_MATCH_FAILED',
  MANUAL_USER_CREATED: 'MANUAL_USER_CREATED',  // ⚠️ 수동등록
  WEBHOOK_REPROCESSED: 'WEBHOOK_REPROCESSED',  // ⚠️ 웹훅 재처리
  SYSTEM_ERROR: 'SYSTEM_ERROR',
} as const;

// ===== 로그 처리 상태 =====
export const LOG_PROCESS_STATUS = {
  SUCCESS: 'SUCCESS',     // 자동 처리 성공
  PENDING: 'PENDING',     // 미처리 (확인/조치 필요)
  RESOLVED: 'RESOLVED',   // 처리 완료
  IGNORED: 'IGNORED',     // 무시됨
} as const;

// ===== 인박스 상태 =====
export const INBOX_STATUS = {
  PENDING: 'PENDING',      // 미처리
  RESOLVED: 'RESOLVED',    // 처리 완료
  IGNORED: 'IGNORED',      // 무시
} as const;

// ===== 인박스 에러 타입 =====
export const INBOX_ERROR_TYPE = {
  PARSE_FAILED: 'PARSE_FAILED',
  SLOT_CONFLICT: 'SLOT_CONFLICT',
  REFUND_MATCH_FAILED: 'REFUND_MATCH_FAILED',
} as const;

// ===== 요일 =====
export const DAY_OF_WEEK = {
  MON: '월',
  TUE: '화',
  WED: '수',
  THU: '목',
  FRI: '금',
  SAT: '토',
  SUN: '일',
} as const;

// ===== 요일 배열 (순서대로) =====
export const DAYS_ARRAY = ['월', '화', '수', '목', '금', '토', '일'] as const;

// ===== 시트 타입 =====
export const SHEET_TYPE = {
  NEW_ENROLLMENT: 'NEW_ENROLLMENT',
  RENEWAL: 'RENEWAL',
} as const;

// ===== API 설정 =====
export const API_CONFIG = {
  SMS_TIMEOUT_MS: 5000,  // 문자 발송 타임아웃 5초
} as const;
```

---

# 📌 4. 데이터가 어떻게 흘러가나요?

## 4.1 기본 원칙

```
🔑 핵심 규칙:
• 구글시트는 데이터를 저장하고 보내는 역할만 함
• 시트는 무조건 보내고, 서버는 무조건 받는다
• 잘못된 데이터라도 일단 받고 나중에 처리
• "결제 취소" 데이터도 자동으로 처리
• 같은 데이터가 2번 와도 1번만 처리 (멱등성)
```

## 4.2 처리 방식: 동기(Synchronous) 처리

> 💡 **왜 동기 처리인가요?**
> - 현재 규모(코치 3명, 수강생 16명)에서는 충분히 빠름
> - 구조가 단순해서 유지보수가 쉬움
> - 나중에 100명+ 규모가 되면 그때 비동기로 전환

**처리 흐름:**
```
[Webhook 수신] 
    → [서명 검증]
    → [중복 체크]
    → [Raw 저장] 
    → [파싱] 
    → [DB 반영] 
    → [문자 발송] 
    → [응답 반환]

⏱️ 예상 소요 시간: 2~3초 (Vercel 제한 10~60초 내 충분)
```

**실패 처리:**
```
서명 검증 실패 → 401 Unauthorized 응답 (저장 안 함)
중복 웹훅 → 로그만 남기고 200 OK (무시)
파싱 실패 → Inbox에 저장 → 성공 응답 (200 OK)
문자 발송 실패 → sms_logs에 기록 → 성공 응답 (200 OK)

⚠️ 실패해도 Raw 데이터는 이미 저장되어 있으므로 데이터 유실 없음
```

## 4.3 웹훅 인증 (가짜 데이터 차단) ⚠️ 보안

**문제**: 아무나 `/api/ingest/sheet` URL을 알면 가짜 결제 데이터를 보낼 수 있음

**해결책**: GAS가 보낼 때 비밀 토큰 포함, 서버가 검증

### GAS 쪽 코드 (구글 시트)
```javascript
function sendToServer(data) {
  const SECRET_TOKEN = 'your-secret-token-here';  // 비밀 토큰
  
  UrlFetchApp.fetch('https://your-server.com/api/ingest/sheet', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-RCCC-Token': SECRET_TOKEN  // 헤더에 토큰 포함
    },
    payload: JSON.stringify(data)
  });
}
```

### 서버 쪽 코드
```typescript
// app/api/ingest/sheet/route.ts
export async function POST(req: Request) {
  const token = req.headers.get('X-RCCC-Token');
  
  if (token !== process.env.WEBHOOK_SECRET_TOKEN) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }
  
  // 정상 처리 계속...
}
```

## 4.4 중복 웹훅 방어 (같은 데이터 2번 방지)

**문제**: 네트워크 이슈로 GAS가 같은 결제를 2번 보낼 수 있음

**해결책**: `전화번호 + 결제일시`를 조합한 멱등키로 중복 체크

```
멱등키 예시: "01012345678_2025-01-20T14:30:00"
```

### 처리 흐름

```
[1단계] 웹훅 수신
    │
    ▼
[2단계] 멱등키 생성 (전화번호 + 결제일시)
    │
    ▼
[3단계] DB에서 같은 멱등키 있는지 확인
    │
    ├─────────────────────────────────────┐
    │                                     │
    ▼                                     ▼
[새로운 데이터]                       [중복 데이터]
정상 처리 진행                        로그만 남기고 무시
                                      (WEBHOOK_DUPLICATE)
                                      200 OK 응답
```

### 코드 예시
```typescript
// 멱등키 생성
const idempotencyKey = `${phone}_${paymentDateTime}`;

// 중복 체크
const existing = await db.raw_webhooks.findFirst({
  where: { idempotency_key: idempotencyKey }
});

if (existing) {
  // 이미 처리한 데이터 → 무시
  await logEvent('WEBHOOK_DUPLICATE', `중복 웹훅 무시: ${idempotencyKey}`);
  return Response.json({ status: 'duplicate_ignored' });
}

// 새 데이터 → 정상 처리
await db.raw_webhooks.create({
  data: { idempotency_key: idempotencyKey, payload: data }
});
```

## 4.5 시트 데이터 구조

> ⚠️ **운영 원칙: 시트 구조 절대 수정 금지!**
> 
> 컬럼 순서나 이름을 바꾸면 파싱이 깨집니다. 변경이 필요하면 반드시 개발자와 협의하세요.

### 신규 결제 시트 컬럼

```
이름 | 이메일 | 전화번호 | 구매옵션 | (설문 항목들...) | 상태 | 결제금액 | 일시 | 결제방식 | 취소사유
```

### 재결제 시트 컬럼

```
이름 | 이메일 | 전화번호 | 구매옵션 | 상태 | 결제금액 | 일시 | 결제방식 | 취소사유
```

### 상태 컬럼 값

| 값 | 의미 |
|----|------|
| (빈 값) 또는 "결제 완료" | 정상 결제 |
| "결제 취소" | Latpeed에서 환불 처리됨 |

### GAS에서 데이터 전송 방식 (권장)

인덱스가 아닌 **헤더 이름**으로 매핑해서 JSON으로 전송:

```javascript
// ❌ 나쁜 예시 - 컬럼 순서 바뀌면 망함
const data = {
  name: row[0],
  phone: row[2],  // 컬럼 순서 바뀌면 엉뚱한 값
};

// ✅ 좋은 예시 - 헤더 이름으로 매핑
const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
const data = {};
headers.forEach((header, index) => {
  data[header] = row[index];
});
// 결과: { "이름": "홍길동", "전화번호": "010-1234-5678", ... }
```

## 4.6 결제 데이터 흐름 (신규/재결제)

```
[1단계] 결제 발생 (Latpeed)
    │
    ▼
[2단계] 구글 시트에 데이터 추가됨
    │
    ▼
[3단계] 시트가 자동으로 우리 서버에 전송
    │
    ▼
[4단계] 서버가 서명 검증 + 중복 체크
    │
    ▼
[5단계] Raw Data 저장 (Save First)
    │
    ▼
[6단계] "상태" 컬럼 확인
    │
    ├─────────────────────────────────────┐
    │                                     │
    ▼                                     ▼
[정상 결제]                           [결제 취소]
데이터 분석(파싱)                     환불 처리 플로우로 이동
    │                                 (4.7 참고)
    ▼
[7단계] 슬롯 충돌 체크
    │
    ├─────────────────────────────────────┐
    │                                     │
    ▼                                     ▼
[슬롯 비어있음]                       [슬롯 충돌]
수강생/세션 정보 저장                 "인박스"에 보관
자동 문자 발송                        관리자에게 알림
```

## 4.7 "결제 취소" 자동 처리 플로우

```
[1단계] 시트에서 "결제 취소" 데이터 수신
    │
    ▼
[2단계] 전화번호로 해당 수강생 찾기
    │
    ▼
[3단계] 구매옵션 파싱 (코치/요일/시간 추출)
    │
    ▼
[4단계] 해당 슬롯의 ACTIVE 또는 PENDING 세션 찾기
    │
    ├─────────────────────────────────────┐
    │                                     │
    ▼                                     ▼
[매칭 성공]                           [매칭 실패]
    │                                     │
    ▼                                     ▼
[5-A] 자동 환불 처리                  [5-B] 인박스로 이동
• 세션 상태 → REFUNDED               • error_type: REFUND_MATCH_FAILED
• 슬롯 자동 오픈                      • 관리자가 수동 처리
• 취소사유 저장
• 히스토리 기록 (REFUND)
    │
    ▼
[6단계] 알림 발송
• 관리자에게 "환불 처리 완료" 알림
• 시스템 로그 기록 (REFUND_AUTO_PROCESSED)
```

### 환불 매칭 로직 상세

```typescript
// 1. 전화번호로 수강생 찾기
const user = await findUserByPhone(normalizePhone(data.phone));

// 2. 구매옵션 파싱
const parsed = parseOption(data.purchaseOption);
// 예: "김다혜/금요일/15:00~15:40" → { coach: "김다혜", day: "금", time: "15:00" }

// 3. 매칭되는 세션 찾기
const session = await findSession({
  userId: user.id,
  coachName: parsed.coach,
  dayOfWeek: parsed.day,
  startTime: parsed.time,
  status: ['ACTIVE', 'PENDING']  // 진행 중인 세션만
});

// 4. 매칭 결과에 따라 처리
if (session) {
  // 자동 환불 처리
  await processRefund(session.id, data.cancelReason);
} else {
  // 인박스로 이동
  await moveToInbox(data, 'REFUND_MATCH_FAILED');
}
```

### 환불 매칭 실패 케이스

| 상황 | 처리 |
|------|------|
| 해당 전화번호의 수강생이 없음 | 인박스 이동 |
| 수강생은 있지만 해당 슬롯 세션이 없음 | 인박스 이동 |
| 이미 EXPIRED/CANCELLED/REFUNDED 상태 | 인박스 이동 (중복 취소 방지) |

## 4.8 슬롯 충돌이란?

**상황**:
```
김다혜 코치 / 화요일 / 19:00 슬롯에
홍길동이 이미 수강 중인데,
새로운 결제 데이터로 박영수가 또 배정되려고 함
```

**시스템 처리**:
1. 자동으로 배정하지 않고 "인박스"로 이동
2. 관리자에게 "슬롯 충돌" 알림 문자 발송
3. 관리자 대시보드에 경고 표시
4. 관리자가 직접 다른 빈 슬롯을 선택해서 배정

## 4.9 데이터 분석(파싱)이 뭔가요?

구글 시트에서 오는 "구매옵션" 텍스트를 분석해서 정보를 추출하는 것입니다.

**예시:**
```
입력: "김다혜 / 화요일 / 19:00 ~ 19:40"
         ↓ 분석 ↓
결과: 코치=김다혜, 요일=화요일, 시간=19:00
```

**분석 성공/실패 케이스:**

| 구매옵션 텍스트 | 결과 | 이유 |
|-----------------|------|------|
| `김다혜 / 화요일 / 19:00 ~ 19:40` | ✅ 성공 | 정상 형식 |
| `김다혜/화/19:00~19:40` | ✅ 성공 | 띄어쓰기 없어도 OK |
| `김민지/금요일/15:00~15:40` | ✅ 성공 | 정상 형식 |
| `김다혜 / 화요일 / 19시` | ❌ 실패 | "19:00" 형식이어야 함 |
| `김다혜 / 화요일` | ❌ 실패 | 시간 정보 없음 |
| `/ 화요일 / 19:00` | ❌ 실패 | 코치 이름 없음 |

실패한 데이터는 "인박스"로 이동해서 관리자가 직접 수정할 수 있습니다.

---

# 📌 5. 날짜는 어떻게 계산되나요?

> ⚠️ **모든 날짜 계산은 KST(Asia/Seoul) 기준입니다!** (섹션 3.2 참고)

## 5.1 신규 등록 - "무조건 다음 주" 규칙

수강 시작일은 **언제 결제하든 무조건 다음 주 해당 요일**입니다.

| 결제일 (KST) | 신청한 반 | 시작일 |
|--------------|-----------|--------|
| 월요일 | 화요일 반 | 다음 주 화요일 |
| 목요일 | 목요일 반 | 다음 주 목요일 (오늘 바로 X) |
| 토요일 | 월요일 반 | 다음 주 월요일 |

**종료일** = 시작일 + 27일 (총 4주, 28일 과정)

> 💡 시작일이 맞지 않으면 관리자가 웹사이트에서 직접 날짜를 수정할 수 있어요!

## 5.2 재결제 - "이어서 연장" 규칙

이미 수업 중인 수강생이 다시 결제하면:

```
현재 수업 종료일: 2월 15일
        ↓
재결제 시 새 시작일: 2월 16일
새 종료일: 3월 15일 (+28일)
```

**핵심**: 수업이 끊기지 않고 이어집니다. 미리 연장 결제도 가능해요!

## 5.3 수강 연기 - "수업 미루기"

수강생 사정으로 1~2주 수업을 미뤄야 할 때:

```
원래 종료일: 2월 15일
1주 연기 신청
        ↓
새 종료일: 2월 22일 (+7일)
```

연기하면 코치 정산에도 자동 반영됩니다 (해당 주는 코칭 없음 처리).

> ⚠️ 2주 이상 쉬어야 하는 경우는 환불 처리를 유도합니다.

## 5.4 결제 취소 (Latpeed 환불)

Latpeed에서 환불 처리되면:
1. ✅ 시트에 "결제 취소" 데이터 추가
2. ✅ 서버가 자동으로 감지
3. ✅ 해당 세션 REFUNDED 처리
4. ✅ 슬롯 자동 오픈
5. ✅ 관리자에게 알림

> ⚠️ **슬롯 변경 기능 없음** - 시간대를 바꾸려면 환불 후 새로 신청

---

# 📌 6. 자동 실행 작업 (크론잡)

> 💡 시스템이 매일 자동으로 실행하는 작업들입니다.
> ⚠️ **모든 시간은 KST(한국 시간) 기준입니다!**

| 작업 | 실행 시간 (KST) | 하는 일 |
|------|-----------------|---------|
| 수업 시작 처리 | 매일 새벽 0시 5분 | 오늘이 시작일인 세션을 "대기" → "수강중"으로 변경 |
| 수업 종료 처리 | 매일 새벽 0시 10분 | 어제가 종료일인 세션을 "수강중" → "종료"로 변경 |
| 리마인더 발송 | 매일 오후 6시 | 내일 수업 있는 사람에게 문자 발송 |

**상태 전환 흐름**:
```
[대기 PENDING] ──시작일 도래──▶ [수강중 ACTIVE] ──종료일 지남──▶ [종료 EXPIRED]
                                      │
                                      │ Latpeed 환불 또는 관리자 취소
                                      ▼
                               [취소 CANCELLED]
                               [환불 REFUNDED]
```

---

# 📌 7. 데이터 저장 구조

> 💡 이 부분은 개발자용입니다. "이런 정보들을 저장한다" 정도만 이해하시면 됩니다!

## 7.1 저장하는 정보 목록

### 👤 수강생 정보 (users)

| 정보 | 설명 | 예시 |
|------|------|------|
| 이름 | 수강생 이름 | 홍길동 |
| 전화번호 | 고유 식별값 (중복 불가) | 01012345678 |
| 이메일 | 선택 | hong@email.com |
| 특이사항 | 메모 | 저녁 늦은 시간 선호 |
| 수동등록 여부 | 시트 거치지 않고 직접 등록 | true/false |
| 수동등록 사유 | 현금결제, 무료체험 등 | 무료 체험 |

> ⚠️ **수강생 상태는 세션 상태로 자동 판단** (별도 status 필드 없음)

### 👨‍🏫 코치 정보 (coaches)

| 정보 | 설명 | 예시 |
|------|------|------|
| 이름 | 코치 이름 | 김다혜 |
| 전화번호 | 연락처 (중복 허용, 중복 시 알림) | 01098765432 |
| 등급 | 견습/일반/선임 | 일반코치 |
| 계좌 정보 | 정산 참고용 (선택) | 국민 123-456-789 |
| 최대 슬롯 수 | 열 수 있는 최대 슬롯 수 | 10 |

> ⚠️ **코치 비활성화 없음** - 슬롯 0개면 자연스럽게 안 쓰임
> ⚠️ 정산 단가는 등급별 고정이므로 코치 테이블에 없음. `constants.ts`의 `COACH_SETTLEMENT` 참고.

### 🕐 슬롯 정보 (coach_slots)

> 슬롯 = 코치가 열어둔 수업 시간대

| 정보 | 설명 | 예시 |
|------|------|------|
| 코치 | 누구의 슬롯인지 | 김다혜 코치 |
| 요일 | 무슨 요일 | 화요일 |
| 시작 시간 | 몇 시 시작 | 19:00 |
| 종료 시간 | 몇 시 끝 | 19:40 |
| 오픈톡 링크 | 카카오톡 오픈채팅 링크 | https://open.kakao.com/xxx |
| 활성 여부 | 현재 열려있는 슬롯인지 | true/false |

### 📅 수강 이력 (sessions)

| 정보 | 설명 | 예시 |
|------|------|------|
| 수강생 | 누구의 수강인지 | 홍길동 |
| 코치 | 담당 코치 | 김다혜 |
| 요일/시간 | 수업 시간 | 화요일 19:00 |
| 시작일 | 수강 시작 | 2025-01-14 |
| 종료일 | 수강 종료 | 2025-02-10 |
| 연장 횟수 | 몇 번 연장했는지 | 1회 |
| 상태 | 대기/수강중/종료/취소/환불/조기종료 | 수강중 |
| 취소 사유 | Latpeed 취소사유 | (환불 시 저장) |
| 조기종료일 | 환불 등으로 종료된 날 | 2025-01-15 |
| 조기종료 사유 | REFUND 등 | 환불 |

### ⏸️ 연기 기록 (postponements)

> 연기한 날짜를 개별 기록합니다. (정산 계산에 사용)

| 정보 | 설명 | 예시 |
|------|------|------|
| 세션 | 어떤 세션의 연기인지 | session_123 |
| 연기 날짜 | 연기한 수업 날짜 | 2025-01-21 |
| 사유 | 연기 사유 (선택) | 수강생 개인 사정 |

### 📝 활동 기록 (user_activity_logs)

수강생에게 일어난 모든 일을 기록합니다.

| 기록 종류 | 설명 |
|-----------|------|
| ENROLL | 신규 등록 |
| RENEWAL | 재결제 (연장) |
| CANCEL | 취소 |
| REFUND | 환불 (Latpeed 자동 또는 수동) |
| POSTPONE | 수강 연기 |
| EARLY_TERMINATE | 조기종료 (환불로 인한) |
| EDIT | 정보 수정 |
| SLOT_TIME_CHANGE | 슬롯 시간 변경 |
| USER_MERGE | 수강생 병합 |

### 📋 변경 이력 (change_logs)

모든 데이터 수정 내역을 추적합니다.

| 정보 | 설명 | 예시 |
|------|------|------|
| 테이블명 | 어떤 데이터가 바뀌었는지 | sessions |
| 레코드 ID | 어떤 항목이 바뀌었는지 | session_123 |
| 필드명 | 어떤 값이 바뀌었는지 | end_date |
| 변경 전 | 이전 값 | 2025-02-10 |
| 변경 후 | 새로운 값 | 2025-02-17 |
| 변경 시간 | 언제 바뀌었는지 | 2025-01-20 14:30 |

### 🔔 시스템 로그 (system_logs)

시스템에서 일어난 모든 일을 기록합니다 (관리자 대시보드용).

| 기록 종류 | 설명 |
|-----------|------|
| WEBHOOK_RECEIVED | 데이터 수신 성공 |
| WEBHOOK_FAILED | 데이터 수신 실패 |
| WEBHOOK_DUPLICATE | 중복 웹훅 감지 (무시됨) |
| PARSE_SUCCESS | 데이터 분석 성공 |
| PARSE_FAILED | 데이터 분석 실패 |
| SMS_SENT | 문자 발송 성공 |
| SMS_FAILED | 문자 발송 실패 |
| SESSION_CREATED | 수강 등록 완료 |
| SESSION_CANCELLED | 수강 취소 |
| SLOT_CONFLICT | 슬롯 충돌 |
| REFUND_AUTO_PROCESSED | 환불 자동 처리 완료 |
| REFUND_MATCH_FAILED | 환불 매칭 실패 → 인박스 |
| SYSTEM_ERROR | 시스템 오류 |
# RCCC PRD v3.4 - Part 2

---

# 📌 8. 화면 구성

## 8.1 전체 메뉴 구조

```
┌─────────────────────────────────────────────────────────┐
│  로고    [대시보드] [코치] [수강생] [메시지] [정산]      │
└─────────────────────────────────────────────────────────┘
```

| 메뉴 | 하는 일 |
|------|---------|
| 대시보드 | 전체 현황 + 오늘의 수업 + 인박스 |
| 코치 | 코치 관리 + 슬롯 관리 + 캘린더 |
| 수강생 | 수강생 관리 + 히스토리 |
| 메시지 | 시스템 로그 + 오류 확인 |
| 정산 | 코치별 월간 코칭 횟수 |

---

## 8.2 대시보드 화면

> ⚠️ **실시간 업데이트**: Supabase Realtime으로 데이터 변경 시 자동 갱신

### 상단 - 핵심 숫자 카드

```
┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐
│ 빈 슬롯  │ │ 인박스   │ │ 수강중   │ │ 종료예정 │ │ 시스템   │
│   12개   │ │  🔴 3    │ │   45명   │ │  D-7: 5명│ │ 오류 🔴2 │
└──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────┘
                                                    (실시간 갱신)
```

| 카드 | 설명 |
|------|------|
| 빈 슬롯 | 현재 수강생이 없는 슬롯 수 |
| 인박스 | 자동 처리 실패해서 수동 확인 필요한 데이터 (빨간 숫자) |
| 수강중 | 현재 수업 진행 중인 수강생 수 |
| 종료예정 | 7일 내 종료되는 수강생 수 (연장 권유 대상) |
| 시스템 오류 | 문자 실패 등 미처리 오류 수 (빨간 숫자) |

### 중단 - 오늘의 수업

```
┌─────────────────────────────────────────────────────────────┐
│  📅 오늘의 수업 (1월 20일 월요일)                    총 3건 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🕐 19:00  김다혜 코치 - 홍길동 (010-1234-5678)            │
│  🕐 19:00  박코치 - 김철수 (010-5678-1234)                 │
│  🕐 20:00  이코치 - 이영희 (010-9999-8888)                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

오늘 어떤 수업이 있는지 한눈에 확인 가능!

### 하단 - 수강 현황 표

| 이름 | 전화번호 | 코치 | 요일/시간 | 시작일 | 종료일 | 상태 | D-Day |
|------|----------|------|-----------|--------|--------|------|-------|
| 홍길동 | 010-1234-5678 | 김다혜 | 화 19:00 | 📅 1/14 | 📅 2/10 | 🟢수강중 | D-14 |
| 김철수 | 010-5678-1234 | 박코치 | 목 20:00 | 📅 1/16 | 📅 2/12 | 🟢수강중 | D-16 |

> 📅 아이콘을 클릭하면 달력이 뜨고, 날짜를 직접 수정할 수 있어요!

### 인박스 섹션

```
┌─────────────────────────────────────────────────────────────┐
│  📥 인박스 (미처리: 3건)                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🔴 환불 매칭 실패                              ⚪미처리    │
│     "박유진 / 금요일 / 15:00" - 해당 세션을 찾을 수 없음    │
│     취소사유: 키키맘 육아클래스 기간 끝나고 신청예정...     │
│                              [수동 처리] [처리완료] [무시]   │
│  ───────────────────────────────────────────────────────    │
│  🔴 슬롯 충돌                                   ⚪미처리    │
│     "박영수 / 화요일 / 19:00" - 김다혜/화/19:00 이미 사용중 │
│                              [수동 배정] [처리완료] [무시]   │
│  ───────────────────────────────────────────────────────    │
│  🟡 파싱 실패                                   ⚪미처리    │
│     "홍길동 / 화요일 / 19시" - 시간 형식 오류               │
│                              [재처리] [처리완료] [무시]      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**인박스 에러 타입:**
- 🔴 환불 매칭 실패: "결제 취소" 데이터가 왔는데 해당 세션을 못 찾음
- 🔴 슬롯 충돌: 이미 사용 중인 슬롯에 배정 시도
- 🟡 파싱 실패: 구매옵션 분석 실패

**인박스 버튼:**
| 버튼 | 설명 |
|------|------|
| [수동 처리] | 수강생 직접 추가 화면으로 이동 |
| [수동 배정] | 다른 슬롯 선택 화면 |
| [재처리] | 원본 웹훅 데이터 다시 처리 |
| [처리완료] | 이미 수동으로 처리함 표시 |
| [무시] | 무시 (잘못된 데이터 등) |

**인박스 상태:**
- ⚪ 미처리 (PENDING)
- ✅ 처리완료 (RESOLVED)
- ⛔ 무시됨 (IGNORED)

---

## 8.3 코치 화면

### 좌측 - 코치 목록

| 이름 | 전화번호 | 등급 | 담당 수강생 | 슬롯 | 단가 |
|------|----------|------|-------------|------|------|
| 김다혜 | 010-9876-5432 | 🏅정식 | 4명 | 3/4 | 5만원 |
| 박코치 | 010-1111-2222 | 🥇선임 | 3명 | 2/3 | 7.5만원 |
| 이코치 | 010-3333-4444 | 🥉견습 | 2명 | 2/2 | 4만원 |

> 3/4 = 4개 슬롯 중 3개 사용 중
> ⚠️ 슬롯 0개인 코치는 목록에서 자동으로 아래로 정렬

**Actions**: [코치 추가] [수정]

> ⚠️ **코치 비활성화 없음** - 슬롯 0개면 자연스럽게 안 쓰임

### 코치 추가 시 전화번호 중복 알림

```
┌─────────────────────────────────────────────────────────────┐
│  ⚠️ 알림                                                    │
│                                                             │
│  입력한 전화번호(010-1111-2222)가                          │
│  박코치와 동일합니다.                                       │
│                                                             │
│  그래도 등록하시겠습니까?                                   │
│                                                             │
│                              [취소] [등록]                  │
└─────────────────────────────────────────────────────────────┘
```

### 우측 상단 - 슬롯 필터 버튼

```
┌─────────────────────────────────────────────────────────────┐
│  [전체 4] [🟢진행중 3] [🟡종료예정 1] [⚪빈슬롯 0]          │
└─────────────────────────────────────────────────────────────┘
```

버튼 클릭으로 원하는 상태의 슬롯만 필터링해서 볼 수 있음

### 우측 중단 - 선택한 코치의 슬롯 상세

```
┌─────────────────────────────────────────────────────────────┐
│  김다혜 코치 (정식코치)                    [+ 슬롯 추가]    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 🟢 화요일 19:00~19:40                               │   │
│  │                                                      │   │
│  │ 수강생: 홍길동 (010-1234-5678)                      │   │
│  │ 종료일: 2025-02-10 (D-14)                           │   │
│  │ 오픈톡: https://open.kakao.com/xxx  [📋복사]        │   │
│  │                                                      │   │
│  │                         [수정] [비활성화]           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 🟡 목요일 20:00~20:40                    종료예정   │   │
│  │                                                      │   │
│  │ 수강생: 김영희 (010-2222-3333)                      │   │
│  │ 종료일: 2025-01-25 (D-5)                            │   │
│  │                                                      │   │
│  │            [연장 권유 문자 발송]                    │   │
│  │                         [수정] [비활성화]           │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ ⚪ 금요일 18:00~18:40                               │   │
│  │                                                      │   │
│  │ 상태: 빈 슬롯                                       │   │
│  │ 오픈톡: https://open.kakao.com/yyy  [📋복사]        │   │
│  │                                                      │   │
│  │                         [수정] [삭제]               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**슬롯 상태 표시**:
- 🟢 진행중: 현재 수강생이 수업 중
- 🟡 종료예정: 7일 내 종료 (연장 권유 대상)
- ⚪ 빈 슬롯: 수강생 없음

**슬롯 버튼:**
- [수정]: 시간, 오픈톡 링크 등 수정
- [비활성화]: 수강생 있는 슬롯 (종료 후 재사용 안 함)
- [삭제]: 빈 슬롯만 삭제 가능

**슬롯 시간 수정 시:**
- 수강생 있어도 수정 가능
- 히스토리에 "슬롯 시간 변경 (19:00 → 20:00)" 기록

**"연장 권유 문자 발송" 버튼**: 
- 종료 예정인 슬롯에만 표시
- 클릭하면 수강생에게 연장 권유 문자 발송
- (문자 내용은 추후 별도 설정 - 작업 리스트 참고)

### 우측 하단 - 코치 수업 캘린더

```
┌─────────────────────────────────────────────────────────────┐
│  김다혜 코치 - 2025년 1월 캘린더                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│     월    화    수    목    금    토    일                  │
│                 1     2     3     4     5                   │
│     6    [7]    8    [9]   10    11    12                   │
│    13   [14]   15   [16]   17    18    19                   │
│    20   (21)   22   [23]   24    25    26                   │
│    27   [28]   29   [30]   31                               │
│                                                             │
│  [7] = 수업 있는 날                                        │
│  (21) = 연기된 날 (회색 또는 취소선)                       │
│                                                             │
│  이번 달 코칭: 7회 (연기 1회 제외)                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**캘린더 표시:**
- `[날짜]` = 정상 수업
- `(날짜)` = 연기됨 (정산에서 제외)

정산할 때 날짜 확인이 더 쉬워짐!

---

## 8.4 수강생 화면

### 펼쳐지는 목록 형식

클릭하면 상세 정보가 펼쳐집니다.

```
┌─────────────────────────────────────────────────────────────┐
│ [🔍 이름/전화번호 검색]        [정렬: 종료임박순 ▼]          │
│                                                             │
│ [전체] [수강중] [대기] [종료예정] [종료] [환불/취소]        │
│                                                     [+ 수강생 추가] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ ▶ 홍길동  010-1234-5678  김다혜/화/19:00  🟢수강중  D-14   │
│   3회차 수강 · 4회 중 2회 완료                              │
│                                                             │
│ ▼ 김철수  010-5678-1234  박코치/목/20:00  🟢수강중  D-16   │
│   2회차 수강 · 4회 중 1회 완료                              │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │                                                         │ │
│ │  [기본정보]                                             │ │
│ │  • 이름: 김철수                                         │ │
│ │  • 전화번호: 010-5678-1234                              │ │
│ │  • 특이사항: 주말 연락 불가                             │ │
│ │                                                         │ │
│ │  [현재 수강] ─────────────────────────────────────────  │ │
│ │  • 상태: 🟢 수강중 (2회차)                              │ │
│ │  • 담당코치: 박코치 / 목요일 / 20:00                    │ │
│ │  • 기간: 2025-01-16 ~ 2025-02-12 (D-16)                │ │
│ │  • 진행: 4회 중 1회 완료 (1/16 ✅)                      │ │
│ │  • 연기: 1/23 연기됨 (개인 사정)                        │ │
│ │  • 결제: 400,000원 (래피드코칭 4회) - 2025-01-10       │ │
│ │                                                         │ │
│ │  [과거 수강] ─────────────────────────────────────────  │ │
│ │  • 1회차: 2024-12-12 ~ 2025-01-08 (종료)               │ │
│ │    김다혜 / 화요일 / 19:00                              │ │
│ │    결제: 400,000원 - 2024-12-05                        │ │
│ │                                                         │ │
│ │  [히스토리] ──────────────────────────────────────────  │ │
│ │  • 2025-01-10  재결제 (2회차)                          │ │
│ │  • 2025-01-20  연기 - 1/23 (개인 사정)                 │ │
│ │  • 2024-12-05  신규등록 (1회차)                        │ │
│ │                                                         │ │
│ │  [변경 이력] ─────────────────────────────────────────  │ │
│ │  • 2025-01-15 14:30 종료일 변경 (2/5 → 2/12)          │ │
│ │                                                         │ │
│ │  [메모] ──────────────────────────────────────────────  │ │
│ │  ┌───────────────────────────────────────────────────┐ │ │
│ │  │ • 1/15: 다음 달 연장 의사 있음                    │ │ │
│ │  └───────────────────────────────────────────────────┘ │ │
│ │                                                         │ │
│ │   [수강 연기] [정보 수정] [수강 취소] [병합]           │ │
│ └─────────────────────────────────────────────────────────┘ │
│                                                             │
│ ▶ 이영희  010-9999-8888  김다혜/금/18:00  ⏸️대기   D-21   │
│   1회차 수강 · 시작 전                                      │
│                                                             │
│ ▶ 최민수  010-1111-2222  박코치/수/10:00  🟢수강중  D-5  (수동등록) │
│   1회차 수강 · 4회 중 3회 완료                              │
│                                                             │
│ ▶ 박유진  010-3219-4886  -              💸환불    -        │
│   취소사유: 키키맘 육아클래스 기간 끝나고 신청예정...       │
│                                                             │
│ ▶ 박민수  010-7777-6666  -              ⚫종료    -        │
│                                                             │
│ ▶ 정수연  010-4444-5555  -              🔸조기종료  -      │
│   환불로 조기종료됨 (1/15)                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 수강생 직접 추가

> ⚠️ **시트에 없는 수강생을 직접 등록 (수동등록 표시)**

**용도:**
- 현금/계좌이체 결제 (Latpeed 안 거친 경우)
- 무료 체험 수업
- 지인/테스트 수강
- 시스템 오류로 시트 연동 실패 시

```
┌─────────────────────────────────────────────────────────────┐
│  수강생 직접 추가                                     [X]   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [기본 정보]                                                │
│  • 이름: [          ]                                       │
│  • 전화번호: [          ]                                   │
│  • 특이사항: [          ]                                   │
│                                                             │
│  [수강 정보]                                                │
│  • 코치: [김다혜 ▼]                                         │
│  • 슬롯: [화요일 19:00 ▼] (빈 슬롯만 표시)                  │
│  • 시작일: [2025-01-21]                                     │
│  • 결제금액: [400000] (선택)                                │
│  • 등록 사유: [무료 체험 ▼]                                 │
│    - 현금/계좌이체                                          │
│    - 무료 체험                                              │
│    - 테스트                                                 │
│    - 시스템 오류 복구                                       │
│    - 기타                                                   │
│                                                             │
│                              [취소] [등록]                  │
└─────────────────────────────────────────────────────────────┘
```

**등록 후:**
- 목록에 `(수동등록)` 표시
- 히스토리에 "수동등록 (사유: 무료 체험)" 기록
- 시트에는 저장 안 됨 (DB만)

### 검색 기능

- 이름으로 검색
- 전화번호 뒷자리로 검색 (예: "5678" 입력)

### 정렬 옵션

| 정렬 | 설명 |
|------|------|
| 종료임박순 (기본) | D-day 적은 순 |
| 등록일순 | 최근 등록 먼저 |
| 이름순 | 가나다순 |
| 코치별 | 코치 이름순 → 종료임박순 |

### 상태 필터

| 필터 | 설명 |
|------|------|
| 전체 | 모든 수강생 |
| 수강중 | ACTIVE |
| 대기 | PENDING |
| 종료예정 | D-7 이내 |
| 종료 | EXPIRED |
| 환불/취소 | REFUNDED, CANCELLED |

### 상태 표시

> ⚠️ **수강생 상태 = 세션 상태로 자동 판단** (별도 상태 필드 없음)

| 조건 | 표시 |
|------|------|
| ACTIVE 세션 있음 | 🟢 수강중 |
| PENDING 세션만 있음 | ⏸️ 대기 |
| 전부 EXPIRED | ⚫ 종료 |
| 최근 세션 CANCELLED | ❌ 취소 |
| 최근 세션 REFUNDED | 💸 환불 (취소사유 함께 표시) |
| 최근 세션 EARLY_TERMINATED | 🔸 조기종료 |

### 할 수 있는 것

- 수강 연기 (1주/2주/3주 선택)
- 정보 수정 (이름, 전화번호, 특이사항 등)
- 수강 취소
- 수강생 병합 (중복 등록된 수강생 합치기)

> ⚠️ **슬롯 변경 기능 없음** - 환불/종료 후 새로 신청

### 수강 연기 UI

```
┌─────────────────────────────────────────────────────────────┐
│  수강 연기                                             [X]   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  홍길동 (화요일 19:00)                                      │
│                                                             │
│  몇 주 연기하시겠습니까?                                    │
│                                                             │
│     [1주]     [2주]     [3주]                               │
│                                                             │
│  1주 선택 시: 1/21 (화) 연기됨                              │
│  2주 선택 시: 1/21, 1/28 (화) 연기됨                        │
│  3주 선택 시: 1/21, 1/28, 2/4 (화) 연기됨                   │
│                                                             │
│  사유: [                    ] (선택)                        │
│                                                             │
│                              [취소] [연기]                  │
└─────────────────────────────────────────────────────────────┘
```

### 수강생 병합

**용도:** 실수로 같은 사람이 2명으로 등록된 경우

```
┌─────────────────────────────────────────────────────────────┐
│  수강생 병합                                           [X]   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [유지할 수강생]                                            │
│  홍길동 (010-1234-5678)                                     │
│  - 세션 2개 (1회차 종료, 2회차 수강중)                      │
│                                                             │
│  [병합할 수강생 선택]                                       │
│  🔍 [이름/전화번호 검색]                                    │
│                                                             │
│  ☑️ 홍길동 (010-1234-5679) ← 번호 오타                      │
│     - 세션 1개 (3회차 수강중)                               │
│                                                             │
│  ──────────────────────────────────────────────────         │
│  병합 결과 미리보기:                                        │
│  홍길동 (010-1234-5678) - 세션 3개                          │
│  ⚠️ 010-1234-5679 수강생은 삭제됩니다                       │
│                                                             │
│                              [취소] [병합]                  │
└─────────────────────────────────────────────────────────────┘
```

**병합 시:**
- 선택한 수강생의 모든 세션이 유지할 수강생으로 이동
- 선택한 수강생은 삭제
- 히스토리에 "수강생 병합 (010-1234-5679 → 010-1234-5678)" 기록

---

## 8.5 관리자 메시지 화면 (시스템 로그)

**목적**: 시스템에서 일어나는 모든 일을 실시간으로 확인

```
┌─────────────────────────────────────────────────────────────┐
│  관리자 메시지 대시보드                                      │
│                                                             │
│  [오늘] [어제] [최근7일] [📅 날짜선택]                      │
│  [전체] [미처리] [처리완료]              [오류만 ☑️]         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  🟢 15:30:00  환불 자동 처리                      [상세 ▼]  │
│     박유진(010-3219-4886) 환불 처리 완료                   │
│     슬롯: 김민지/금/15:00 → 자동 오픈                      │
│  ──────────────────────────────────────────────────────    │
│  🔴 14:32:15  문자 발송 실패               ⚪미처리 [상세 ▼] │
│     홍길동(010-1234-5678) 등록 알림 발송 실패              │
│     오류: Solapi 인증 오류                                 │
│                                    [재시도] [처리완료] [무시]│
│  ──────────────────────────────────────────────────────    │
│  🔴 14:25:10  웹훅 처리 실패               ⚪미처리 [상세 ▼] │
│     "홍길동 / 화요일 / 19시" 파싱 실패                     │
│     오류: 시간 형식 불일치                                 │
│     재시도: 0회                                            │
│                                    [재처리] [처리완료] [무시]│
│  ──────────────────────────────────────────────────────    │
│  🟡 14:31:00  환불 매칭 실패               ✅처리완료        │
│     "박영수 / 화요일 / 19:00" - 수동 처리됨                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 로그 상세 보기

[상세 ▼] 클릭 시 펼쳐짐:

```
┌─────────────────────────────────────────────────────────────┐
│  🔴 14:25:10  웹훅 처리 실패                       [상세 ▲] │
│                                                             │
│  [기본 정보]                                                │
│  • 시간: 2025-01-20 14:25:10                               │
│  • 타입: PARSE_FAILED                                       │
│  • 상태: 미처리                                             │
│  • 재시도: 0회                                              │
│                                                             │
│  [에러 상세]                                                │
│  • 메시지: 시간 형식 불일치                                 │
│  • 입력값: "19시"                                           │
│  • 예상값: "19:00" 형식                                     │
│                                                             │
│  [원본 데이터]                                              │
│  {                                                          │
│    "name": "홍길동",                                        │
│    "phone": "010-1234-5678",                               │
│    "day": "화요일",                                         │
│    "time": "19시",                                          │
│    "coach": "김다혜"                                        │
│  }                                                          │
│                                                             │
│                                    [재처리] [처리완료] [무시]│
└─────────────────────────────────────────────────────────────┘
```

### 필터 옵션

**날짜 필터:**
| 필터 | 설명 |
|------|------|
| 오늘 | 오늘 로그만 |
| 어제 | 어제 로그만 |
| 최근7일 | 7일간 로그 |
| 날짜선택 | 특정 날짜 범위 |

**상태 필터:**
| 필터 | 설명 |
|------|------|
| 전체 | 모든 로그 |
| 미처리 | 확인/조치 필요한 로그 |
| 처리완료 | 처리 완료된 로그 |

### 아이콘 의미

- 🟢 성공 (자동 처리 완료)
- 🔴 실패 (확인 필요)
- 🟡 경고 (확인 권장)
- ⚪ 미처리
- ✅ 처리완료
- ⛔ 무시됨

### 버튼 설명

| 버튼 | 설명 |
|------|------|
| [재시도] | 문자 발송 재시도 |
| [재처리] | 웹훅 원본 데이터 다시 처리 |
| [처리완료] | 수동으로 처리 완료 표시 |
| [무시] | 무시 처리 (더 이상 알림 안 함) |

---

## 8.6 코치 정산 화면

**목적**: 이번 달 코치에게 얼마를 줘야 하는지 + 회사 수익 확인 (읽기 전용)

> ⚠️ **정산 수정은 코치탭에서 슬롯/세션을 수정하세요. 정산 화면에서는 수정 불가.**

```
┌─────────────────────────────────────────────────────────────┐
│  코치 정산                [◀ 2024.12] [2025년 1월] [▶]      │
│                                              [✅ 확정됨]     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 코치명   등급      1회 단가   코칭횟수  정산금  상세│   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ 김다혜   일반코치   5만원      16회     80만원 [보기]│   │
│  │ 박코치   선임코치   7.5만원    12회     90만원 [보기]│   │
│  │ 이코치   견습코치   4만원       8회     32만원 [보기]│   │
│  ├─────────────────────────────────────────────────────┤   │
│  │                        코치 지급 합계    202만원     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  📊 2025년 1월 요약                                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  총 코칭 횟수        36회                            │   │
│  │  매출 (코칭 기준)    370만원                         │   │
│  │  코치 지급 합계      202만원                         │   │
│  │  ────────────────────────────────                   │   │
│  │  회사 수익           168만원                         │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│                       [정산 확정] 또는 [확정 취소]          │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  [김다혜 코치 상세] - 2025년 1월                            │
│                                                             │
│  슬롯1: 화요일 19:00 - 홍길동                               │
│  • 1/7  (화) ✅ 정상                                        │
│  • 1/14 (화) ✅ 정상                                        │
│  • 1/21 (화) ⏸️ 연기 (수강생 사정)                          │
│  • 1/28 (화) ✅ 정상                                        │
│  소계: 3회 × 10만원(매출) = 30만원                          │
│                                                             │
│  슬롯2: 목요일 20:00 - 김철수                               │
│  • 1/9  (목) ✅ 정상                                        │
│  • 1/16 (목) ✅ 정상                                        │
│  • 1/23 (목) ✅ 정상                                        │
│  • 1/30 (목) ✅ 정상                                        │
│  소계: 4회 × 10만원(매출) = 40만원                          │
│                                                             │
│  슬롯3: 금요일 15:00 - 박유진 (1/17 환불)                   │
│  • 1/10 (금) ✅ 정상                                        │
│  • 1/17 (금) 💸 환불 (이후 제외)                            │
│  소계: 1회 × 10만원(매출) = 10만원                          │
│                                                             │
│  슬롯4: 화요일 20:00 - 이영희 (1/15 슬롯변경으로 전입)      │
│  • 1/21 (화) ✅ 정상                                        │
│  • 1/28 (화) ✅ 정상                                        │
│  소계: 2회 × 10만원(매출) = 20만원                          │
│                                                             │
│  ──────────────────────────────────────────────────         │
│  김다혜 코치 1월 합계:                                      │
│  • 매출: 100만원 (10회 × 10만원)                            │
│  • 코치 지급: 50만원 (10회 × 5만원)                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 정산 확정 기능

**목적:** 정산 완료 후 실수로 과거 데이터 수정 방지

**동작:**
```
[정산 확정] 클릭
    ↓
"2025년 1월 정산을 확정하시겠습니까?"
"확정 후 1월 세션 수정 시 경고가 표시됩니다."
    ↓
확정 완료 → 화면에 "✅ 확정됨" 표시
```

**확정된 월의 세션 수정 시:**
```
⚠️ 경고

2025년 1월 정산이 이미 확정되었습니다.
수정하면 정산 금액이 변경될 수 있습니다.

정말 수정하시겠습니까?

[취소] [수정]
```

**확정 취소:**
- [확정 취소] 버튼으로 다시 미확정 상태로 변경 가능
- 실수 대비

### 매출 계산 방식 (코칭 기준)

> ⚠️ **매출은 결제일이 아닌 코칭 횟수 기준으로 계산**

**등급별 1회당 금액:**

| 등급 | 패키지 가격 | 1회 매출 | 코치 지급 | 회사 수익 |
|------|------------|---------|----------|----------|
| 견습 | 40만원/4회 | 10만원 | 4만원 | 6만원 |
| 일반 | 40만원/4회 | 10만원 | 5만원 | 5만원 |
| 선임 | 50만원/4회 | 12.5만원 | 7.5만원 | 5만원 |

**계산 공식:**
```
월 매출 = Σ (코칭횟수 × 1회 매출)
코치 지급 = Σ (코칭횟수 × 코치 단가)
회사 수익 = 월 매출 - 코치 지급
```

**예시 (1월 15일 결제, 1/21~2/17 수업):**
```
→ 1월: 2회 코칭 → 매출 20만원
→ 2월: 2회 코칭 → 매출 20만원
(결제 시점과 무관하게 코칭 시점 기준)
```

### 정산 횟수에서 제외되는 경우

| 케이스 | 처리 |
|--------|------|
| 수강생 연기 | ❌ 연기한 날짜 제외 |
| 환불 | ❌ 환불일 이후 제외 |
| 조기종료 (슬롯변경) | ❌ 종료일 이후 제외 |
| 수강생 노쇼 | ✅ 포함 (코치 책임 아님) |
| 코치 휴강 + 보강 | ✅ 포함 (같은 주 보강이므로 안 쉰 것) |

### 월 경계 세션 처리

```
세션: 1/20 ~ 2/16 (화요일)
→ 1월 정산: 1/21, 1/28 (2회만 포함)
→ 2월 정산: 2/4, 2/11 (2회만 포함)
```

### 등급 변경 시

- 해당 월은 **변경 전 등급**으로 통일 계산
- 예: 1월 15일 견습→일반 승급 → 1월은 견습 단가(4만원) 적용
# RCCC PRD v3.6 - Part 3

---

# 📌 9. 실수 방지 안전장치

## 9.1 확인창이 뜨는 경우

| 위험한 동작 | 안전장치 |
|-------------|----------|
| 수강 취소 | "정말 취소하시겠습니까?" 확인창 + 사유 필수 입력 |
| 슬롯 비활성화 (수강생 있을 때) | ❌ 비활성화 불가, "수강 종료 후 비활성화 가능" 안내 |
| 슬롯 시간 수정 (수강생 있을 때) | "수강생에게 알림이 발송됩니다" 확인 |
| 날짜 수정 | 변경 전/후 날짜 비교 표시 + "변경하시겠습니까?" 확인 |
| 수강생 병합 | 병합 결과 미리보기 + "삭제됩니다" 경고 |

## 9.2 날짜 수정 확인창 예시

```
┌─────────────────────────────────────────────────────────────┐
│  📅 종료일 변경                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  수강생: 홍길동                                             │
│                                                             │
│  변경 전: 2025-02-10 (D-14)                                │
│  변경 후: 2025-02-17 (D-21)                                │
│                                                             │
│  차이: +7일                                                 │
│                                                             │
│                              [취소]  [변경 확인]            │
└─────────────────────────────────────────────────────────────┘
```

## 9.3 수강생 병합 확인창 예시

```
┌─────────────────────────────────────────────────────────────┐
│  ⚠️ 수강생 병합                                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  유지: 홍길동 (010-1234-5678) - 세션 2개                   │
│  삭제: 홍길동 (010-1234-5679) - 세션 1개                   │
│                                                             │
│  결과: 홍길동 (010-1234-5678) - 세션 3개                   │
│                                                             │
│  ⚠️ 010-1234-5679 수강생은 영구 삭제됩니다.                │
│     이 작업은 되돌릴 수 없습니다.                          │
│                                                             │
│                              [취소]  [병합 확인]            │
└─────────────────────────────────────────────────────────────┘
```

---

# 📌 10. 문자 알림 시스템

## 10.1 언제 누구에게 문자가 가나요?

| 상황 | 수강생 | 코치 | 관리자 |
|------|--------|------|--------|
| 신규 등록 | ✅ 등록 안내 | ✅ 새 수강생 알림 | ✅ 등록 알림 |
| 재결제 (연장) | ✅ 연장 안내 | ✅ 연장 알림 | - |
| **Latpeed 환불 (자동)** | - | - | ✅ 환불 처리 알림 |
| **환불 매칭 실패** | - | - | ✅ 인박스 확인 알림 |
| 수강 취소 (수동) | ✅ 취소 확인 | ✅ 취소 알림 | ✅ 취소 알림 |
| 수강 연기 | ✅ 연기 안내 | ✅ 연기 알림 | - |
| 슬롯 시간 변경 | ✅ 시간 변경 안내 | ✅ 시간 변경 알림 | - |
| 수업 하루 전 | ✅ 리마인더 | ✅ 리마인더 | - |
| Tally 설문 제출 | ✅ 오픈톡 링크 안내 | ✅ 설문 도착 | - |
| 슬롯 충돌 | - | - | ✅ 충돌 알림 |
| 시스템 오류 | - | - | ✅ 오류 알림 |
| 연장 권유 (수동) | ✅ 연장 권유 | - | - |

## 10.2 문자 발송 타임아웃

> ⚠️ Vercel 서버리스 환경에서 타임아웃 방지를 위해 문자 발송에 제한 시간을 둡니다.

- **타임아웃**: 5초
- 5초 안에 Solapi 응답이 없으면 → "발송 실패" 처리
- `sms_logs`에 실패 기록 → 나중에 "재시도" 버튼으로 수동 재발송

## 10.3 리마인더 중복 발송 방지

> ⚠️ 크론잡이 가끔 2번 실행될 수 있어서, 같은 문자가 2번 가는 걸 방지합니다.

**방법**: `reminder_logs` 테이블에서 "같은 세션 + 같은 날짜"는 1번만 발송

```
크론잡 1번째 실행: reminder_log 생성 → 문자 발송 ✅
크론잡 2번째 실행: "이미 있네?" → 무시 (문자 안 감) ✅
```

## 10.4 연장 권유 문자

- 코치탭 슬롯 상세에서 "연장 권유 문자 발송" 버튼 클릭
- 종료 예정 (D-7 이내) 수강생에게 발송
- 문자 내용은 별도 설정 (작업 리스트 참고)

---

# 📌 11. 개발자를 위한 기술 명세

## 11.0 실시간 업데이트 (Supabase Realtime)

대시보드와 메시지 화면은 실시간으로 데이터가 갱신됩니다.

```typescript
// 실시간 구독 예시
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// 세션 변경 구독 (새 등록, 취소 등)
supabase
  .channel('sessions-changes')
  .on('postgres_changes', { 
    event: '*', 
    schema: 'public', 
    table: 'sessions' 
  }, (payload) => {
    refreshDashboard();  // 대시보드 갱신
  })
  .subscribe();

// 시스템 로그 구독 (새 로그 발생)
supabase
  .channel('logs-changes')
  .on('postgres_changes', { 
    event: 'INSERT', 
    schema: 'public', 
    table: 'system_logs' 
  }, (payload) => {
    addNewLog(payload.new);  // 로그 목록에 추가
  })
  .subscribe();

// 인박스 구독 (새 에러 발생)
supabase
  .channel('inbox-changes')
  .on('postgres_changes', { 
    event: '*', 
    schema: 'public', 
    table: 'inbox' 
  }, (payload) => {
    refreshInbox();  // 인박스 갱신
  })
  .subscribe();
```

**구독 대상 테이블:**
| 테이블 | 이벤트 | 용도 |
|--------|--------|------|
| sessions | INSERT, UPDATE, DELETE | 대시보드 KPI 갱신 |
| system_logs | INSERT | 메시지 화면 실시간 로그 |
| inbox | INSERT, UPDATE | 인박스 미처리 건수 |

## 11.1 데이터베이스 스키마 (SQL)

```sql
-- =====================================================
-- 수강생 (users)
-- =====================================================
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  phone TEXT NOT NULL UNIQUE,
  email TEXT,
  memo TEXT,
  -- ⚠️ 수동등록 관련 필드
  is_manual_entry BOOLEAN DEFAULT FALSE,  -- 수동등록 여부
  manual_entry_reason TEXT,  -- 수동등록 사유 (현금결제, 무료체험, 테스트 등)
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
-- ⚠️ status, is_active 삭제됨
-- 수강생 상태는 세션 상태로 자동 판단

-- =====================================================
-- 코치 (coaches)
-- =====================================================
CREATE TABLE coaches (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  phone TEXT,  -- ⚠️ 중복 허용 (중복 시 알림만 표시)
  grade TEXT DEFAULT 'REGULAR' 
    CHECK (grade IN ('TRAINEE', 'REGULAR', 'SENIOR')),
  -- ⚠️ rate_per_session 삭제: 등급별 정산 단가는 constants.ts에서 관리
  bank_account TEXT,
  max_slots INTEGER DEFAULT 10,
  -- ⚠️ is_active 삭제: 슬롯 0개면 자연스럽게 안 쓰임
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- =====================================================
-- 슬롯 (coach_slots)
-- =====================================================
CREATE TABLE coach_slots (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  coach_id UUID NOT NULL REFERENCES coaches(id),
  day_of_week TEXT NOT NULL 
    CHECK (day_of_week IN ('월', '화', '수', '목', '금', '토', '일')),
  start_time TIME NOT NULL,  -- ⚠️ TEXT → TIME 변경
  end_time TIME,             -- ⚠️ TEXT → TIME 변경
  open_chat_link TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(coach_id, day_of_week, start_time)
);

-- =====================================================
-- 수강 이력 (sessions)
-- =====================================================
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  coach_id UUID NOT NULL REFERENCES coaches(id),
  slot_id UUID REFERENCES coach_slots(id),
  day_of_week TEXT NOT NULL,
  start_time TIME NOT NULL,  -- ⚠️ TEXT → TIME 변경
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  extension_count INTEGER DEFAULT 0,
  status TEXT NOT NULL DEFAULT 'PENDING' 
    CHECK (status IN ('PENDING', 'ACTIVE', 'EXPIRED', 'CANCELLED', 'REFUNDED', 'EARLY_TERMINATED')),
  cancelled_at TIMESTAMPTZ,
  cancellation_reason TEXT,
  -- ⚠️ 조기종료 관련 필드
  early_terminated_at DATE,
  early_termination_reason TEXT 
    CHECK (early_termination_reason IN ('REFUND', 'OTHER')),
  -- ⚠️ 결제 정보 필드
  payment_amount INTEGER,         -- 결제 금액 (원)
  payment_date DATE,              -- 결제일
  product_name TEXT,              -- 상품명 (예: "래피드코칭 4회")
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- =====================================================
-- 연기 기록 (postponements) - ⚠️ 신규 테이블
-- =====================================================
CREATE TABLE postponements (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id),
  postponed_date DATE NOT NULL,  -- 연기한 수업 날짜
  reason TEXT,                    -- 연기 사유 (선택)
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- =====================================================
-- 활동 로그 (user_activity_logs)
-- =====================================================
CREATE TABLE user_activity_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  session_id UUID REFERENCES sessions(id),
  action_type TEXT NOT NULL 
    CHECK (action_type IN ('ENROLL', 'RENEWAL', 'CANCEL', 'REFUND', 'POSTPONE', 'EARLY_TERMINATE', 'EDIT', 'SLOT_TIME_CHANGE', 'USER_MERGE')),
  reason TEXT,
  metadata JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- =====================================================
-- 변경 이력 (change_logs)
-- =====================================================
CREATE TABLE change_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  table_name TEXT NOT NULL,
  record_id UUID NOT NULL,
  field_name TEXT NOT NULL,
  old_value TEXT,
  new_value TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- =====================================================
-- 시스템 로그 (system_logs)
-- =====================================================
CREATE TABLE system_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_type TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'SUCCESS',
  message TEXT NOT NULL,
  error_detail TEXT,
  -- ⚠️ 재처리 관련 필드
  raw_data JSONB,                -- 원본 웹훅 데이터 (재처리용)
  retryable BOOLEAN DEFAULT FALSE,
  retry_count INTEGER DEFAULT 0, -- 재시도 횟수
  retry_payload JSONB,
  -- ⚠️ 처리 상태 필드
  process_status TEXT DEFAULT 'SUCCESS'
    CHECK (process_status IN ('SUCCESS', 'PENDING', 'RESOLVED', 'IGNORED')),
  resolved_at TIMESTAMPTZ,       -- 처리 완료 시간
  resolved_by TEXT,              -- 처리한 관리자 (선택)
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- ⚠️ process_status 설명:
-- SUCCESS: 자동 처리 성공 (별도 조치 불필요)
-- PENDING: 미처리 (확인/조치 필요)
-- RESOLVED: 처리 완료
-- IGNORED: 무시됨

-- =====================================================
-- 문자 발송 로그 (sms_logs) - ⚠️ 개선됨
-- =====================================================
CREATE TABLE sms_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  recipient_phone TEXT NOT NULL,
  recipient_type TEXT NOT NULL,
  message_content TEXT NOT NULL,
  status TEXT NOT NULL DEFAULT 'PENDING',
  error_message TEXT,
  provider_message_id TEXT,     -- ⚠️ 추가: Solapi 응답 ID (추적용)
  retry_count INTEGER DEFAULT 0, -- ⚠️ 추가: 재시도 횟수
  idempotency_key TEXT UNIQUE,  -- ⚠️ 추가: 중복 발송 방지
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- =====================================================
-- 리마인더 로그 (reminder_logs) - ⚠️ 신규 테이블
-- =====================================================
CREATE TABLE reminder_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES sessions(id),
  remind_date DATE NOT NULL,
  status TEXT NOT NULL DEFAULT 'PENDING'
    CHECK (status IN ('PENDING', 'SENT', 'FAILED')),
  sent_at TIMESTAMPTZ,
  error_message TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(session_id, remind_date)  -- ⚠️ 같은 날 같은 세션은 1번만
);

-- =====================================================
-- Raw 데이터 (raw_webhooks) - ⚠️ 개선됨
-- =====================================================
CREATE TABLE raw_webhooks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  source TEXT NOT NULL,
  payload JSONB NOT NULL,
  idempotency_key TEXT UNIQUE,  -- ⚠️ 추가: 중복 웹훅 방지
  processed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- =====================================================
-- 인박스 (ingestion_inbox)
-- =====================================================
CREATE TABLE ingestion_inbox (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  raw_webhook_id UUID REFERENCES raw_webhooks(id),
  raw_text TEXT,
  error_message TEXT,
  error_type TEXT,  -- PARSE_FAILED, SLOT_CONFLICT, REFUND_MATCH_FAILED
  manual_resolution_status TEXT DEFAULT 'PENDING',
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- =====================================================
-- 정산 확정 (settlement_locks) - ⚠️ 신규 테이블
-- =====================================================
CREATE TABLE settlement_locks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  year INTEGER NOT NULL,
  month INTEGER NOT NULL,
  locked_at TIMESTAMPTZ DEFAULT NOW(),
  unlocked_at TIMESTAMPTZ,  -- 확정 취소 시 기록
  UNIQUE(year, month)
);

-- =====================================================
-- 인덱스 (성능 최적화)
-- =====================================================
CREATE INDEX idx_sessions_status ON sessions(status);
CREATE INDEX idx_sessions_end_date ON sessions(end_date);
CREATE INDEX idx_sessions_start_date ON sessions(start_date);
CREATE INDEX idx_sessions_coach_id ON sessions(coach_id);
CREATE INDEX idx_sessions_user_id ON sessions(user_id);
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_system_logs_created_at ON system_logs(created_at);
CREATE INDEX idx_system_logs_event_type ON system_logs(event_type);
CREATE INDEX idx_activity_logs_user_id ON user_activity_logs(user_id);
CREATE INDEX idx_inbox_status ON ingestion_inbox(manual_resolution_status);
CREATE INDEX idx_reminder_logs_date ON reminder_logs(remind_date);
CREATE INDEX idx_postponements_session ON postponements(session_id);  -- ⚠️ 추가
CREATE INDEX idx_postponements_date ON postponements(postponed_date);  -- ⚠️ 추가
CREATE INDEX idx_settlement_locks ON settlement_locks(year, month);  -- ⚠️ 추가
```

## 11.2 주요 API 목록

> ⚠️ **비활성화는 DELETE 대신 PATCH 사용**

| 메서드 | 경로 | 설명 |
|--------|------|------|
| POST | /api/ingest/sheet | 구글시트 데이터 수신 (신규/재결제/취소 모두) |
| POST | /api/ingest/tally | Tally 설문 수신 |
| GET | /api/sessions | 세션 목록 조회 |
| GET | /api/sessions/today | 오늘의 수업 목록 |
| PATCH | /api/sessions/[id] | 세션 수정 |
| POST | /api/sessions/[id]/cancel | 세션 취소 |
| POST | /api/sessions/[id]/postpone | 수강 연기 |
| GET | /api/coaches | 코치 목록 |
| POST | /api/coaches | 코치 추가 |
| PATCH | /api/coaches/[id] | 코치 정보 수정 |
| GET | /api/coaches/[id]/calendar | 코치 캘린더 |
| GET | /api/slots | 슬롯 목록 |
| GET | /api/slots/available | 빈 슬롯 목록 |
| POST | /api/slots | 슬롯 추가 |
| PATCH | /api/slots/[id] | 슬롯 수정 **또는 비활성화** |
| DELETE | /api/slots/[id] | 빈 슬롯 삭제 |
| GET | /api/users | 수강생 목록 |
| GET | /api/users/search | 수강생 검색 |
| POST | /api/users | 수강생 직접 추가 (수동등록) |
| PATCH | /api/users/[id] | 수강생 정보 수정 |
| POST | /api/users/merge | 수강생 병합 |
| GET | /api/logs | 시스템 로그 목록 (날짜/상태 필터) |
| POST | /api/logs/[id]/retry | 문자 발송 재시도 |
| POST | /api/logs/[id]/reprocess | 웹훅 원본 데이터 재처리 |
| PATCH | /api/logs/[id]/status | 로그 처리상태 변경 (RESOLVED/IGNORED) |
| GET | /api/inbox | 인박스 목록 |
| PATCH | /api/inbox/[id]/status | 인박스 상태 변경 |
| GET | /api/settlement | 코치 정산 (월별 조회) |
| GET | /api/settlement/summary | 월 요약 (매출/지급/수익) |
| POST | /api/settlement/lock | 정산 확정 |
| POST | /api/settlement/unlock | 정산 확정 취소 |
| POST | /api/notify/extension-reminder | 연장 권유 문자 발송 |
| POST | /api/cron/session-status | 세션 상태 전환 (크론잡) |
| POST | /api/cron/reminder | 리마인더 발송 (크론잡) |

### 비활성화 API 사용 예시

```typescript
// ❌ 기존 방식 (혼란 유발)
// DELETE /api/coaches/123

// ✅ 새 방식 (명확함)
// PATCH /api/coaches/123
// Body: { "is_active": false }
```

## 11.3 폴더 구조

```
app/
├── page.tsx                    # 대시보드
├── coaches/page.tsx            # 코치 관리
├── students/page.tsx           # 수강생 관리
├── messages/page.tsx           # 시스템 로그
├── settlement/page.tsx         # 코치 정산
└── api/
    ├── ingest/
    │   ├── sheet/route.ts      # 구글시트 웹훅 (서명 검증 포함)
    │   └── tally/route.ts
    ├── sessions/
    ├── coaches/
    ├── slots/
    ├── users/
    ├── logs/
    ├── settlement/
    ├── notify/
    └── cron/
        ├── session-status/route.ts
        └── reminder/route.ts
lib/
├── constants.ts                # 상수 정의 (필수!)
├── dayjs.ts                    # 타임존 설정된 dayjs (필수!)
├── webhook-auth.ts             # 웹훅 인증 (신규!)
├── supabase/
│   ├── client.ts
│   └── server.ts
└── utils/
    ├── phone-normalizer.ts     # 전화번호 정규화
    ├── option-parser.ts        # 구매옵션 파싱
    ├── date-calculator.ts      # 날짜 계산 (KST 기준)
    ├── idempotency.ts          # 멱등키 생성 (신규!)
    └── refund-processor.ts     # 환불 자동 처리
```

## 11.4 환경변수 목록

```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx...
SUPABASE_SERVICE_ROLE_KEY=eyJxxx...

# Solapi (문자 발송)
SOLAPI_API_KEY=xxx
SOLAPI_API_SECRET=xxx
SOLAPI_SENDER_PHONE=01012345678

# 관리자
ADMIN_PHONE=01012345678
ADMIN_NAME=관리자

# 웹훅 인증 (신규!)
WEBHOOK_SECRET_TOKEN=your-secret-token-here

# 크론잡 인증 (선택)
CRON_SECRET=random-secret-string
```

## 11.5 dayjs 설정 파일

```typescript
// lib/dayjs.ts
import dayjs from 'dayjs';
import timezone from 'dayjs/plugin/timezone';
import utc from 'dayjs/plugin/utc';
import 'dayjs/locale/ko';

dayjs.extend(utc);
dayjs.extend(timezone);
dayjs.tz.setDefault('Asia/Seoul');
dayjs.locale('ko');

export default dayjs;
```

## 11.6 웹훅 인증 파일

```typescript
// lib/webhook-auth.ts
export function verifyWebhookToken(req: Request): boolean {
  const token = req.headers.get('X-RCCC-Token');
  return token === process.env.WEBHOOK_SECRET_TOKEN;
}
```

## 11.7 멱등키 생성 파일

```typescript
// lib/utils/idempotency.ts
import { normalizePhone } from './phone-normalizer';

export function generateIdempotencyKey(phone: string, paymentDateTime: string): string {
  const normalized = normalizePhone(phone);
  return `${normalized}_${paymentDateTime}`;
}

// 사용 예시:
// generateIdempotencyKey('010-1234-5678', '2025-01-20T14:30:00')
// → '01012345678_2025-01-20T14:30:00'
```

## 11.8 전화번호 정규화 파일 ⚠️ 중요

> 🚨 **고객은 전화번호를 다양한 형식으로 입력합니다. 정규화 안 하면 같은 사람이 중복 생성됩니다!**

```typescript
// lib/utils/phone-normalizer.ts

/**
 * 전화번호를 정규화합니다.
 * 
 * 입력 예시:
 * - '010-1234-5678'  → '01012345678'
 * - '010 1234 5678'  → '01012345678'
 * - '010.1234.5678'  → '01012345678'
 * - '+82 10-1234-5678' → '01012345678'
 * - '+821012345678'  → '01012345678'
 * - '82-10-1234-5678' → '01012345678'
 */
export function normalizePhone(phone: string): string {
  if (!phone) return '';
  
  // 1. 숫자만 남기기 (하이픈, 공백, 점, 괄호 등 모두 제거)
  let digits = phone.replace(/\D/g, '');
  
  // 2. 국제번호 처리 (82로 시작하면 제거하고 0 붙이기)
  if (digits.startsWith('82')) {
    digits = '0' + digits.slice(2);
  }
  
  // 3. 길이 검증 (한국 휴대폰: 10~11자리)
  if (digits.length < 10 || digits.length > 11) {
    // 그래도 뒤에서 11자리 추출 시도
    digits = digits.slice(-11);
  }
  
  // 4. 010으로 시작 안 하면 010 붙이기 시도 (10자리인 경우)
  if (digits.length === 10 && !digits.startsWith('0')) {
    digits = '0' + digits;
  }
  
  return digits;
}

/**
 * 전화번호가 유효한지 검증합니다.
 */
export function isValidPhone(phone: string): boolean {
  const normalized = normalizePhone(phone);
  // 010, 011, 016, 017, 018, 019로 시작하는 10~11자리
  return /^01[0-9]{8,9}$/.test(normalized);
}

// 사용 예시
// normalizePhone('+82 10-1234-5678')  → '01012345678'
// normalizePhone('010.1234.5678')     → '01012345678'
// isValidPhone('010-1234-5678')       → true
// isValidPhone('02-123-4567')         → false (휴대폰 아님)
```

## 11.9 타임아웃 유틸리티 파일

```typescript
// lib/utils/timeout.ts

/**
 * Promise에 타임아웃을 적용합니다.
 * 지정된 시간 내에 완료되지 않으면 에러를 던집니다.
 */
export async function withTimeout<T>(
  promise: Promise<T>,
  ms: number,
  errorMessage = 'Timeout'
): Promise<T> {
  const timeout = new Promise<never>((_, reject) =>
    setTimeout(() => reject(new Error(errorMessage)), ms)
  );
  return Promise.race([promise, timeout]);
}

// 사용 예시:
// await withTimeout(sendSms(phone, message), 4000, 'SMS 발송 타임아웃');
```

---

# 📌 12. 체크리스트 (개발 완료 확인용)

## Next.js 캐싱
- [ ] 모든 `page.tsx`에 `export const dynamic = 'force-dynamic'`이 있는가?
- [ ] 모든 API `route.ts`에 `export const dynamic = 'force-dynamic'`이 있는가?
- [ ] fetch 사용 시 `{ cache: 'no-store' }` 옵션을 주는가?

## 에러 격리
- [ ] 문자 발송이 try-catch로 감싸져 있는가?
- [ ] 문자 실패해도 전체 프로세스가 성공 응답하는가?
- [ ] `withTimeout` 유틸리티가 구현되었는가?
- [ ] SMS 타임아웃이 4~5초로 설정되었는가?

## 타임존
- [ ] `lib/dayjs.ts` 파일이 생성되었는가?
- [ ] 모든 날짜 계산에 설정된 dayjs를 사용하는가?
- [ ] JavaScript 기본 `Date` 또는 기본 `dayjs`를 직접 사용하지 않는가?
- [ ] 크론잡 실행 시간이 KST 기준으로 설정되었는가?

## 전화번호 정규화
- [ ] `phone-normalizer.ts` 파일이 구현되었는가?
- [ ] 모든 전화번호 저장/조회 시 정규화를 거치는가?
- [ ] 국제번호(+82)가 제대로 처리되는가?
- [ ] 공백, 하이픈, 점이 제거되는가?

## 웹훅 보안
- [ ] `WEBHOOK_SECRET_TOKEN` 환경변수가 설정되었는가?
- [ ] `/api/ingest/sheet`에서 토큰 검증을 하는가?
- [ ] GAS에서 `X-RCCC-Token` 헤더를 보내는가?
- [ ] 토큰 불일치 시 401 응답을 하는가?

## 중복 방지 (멱등성)
- [ ] 웹훅 수신 시 멱등키를 생성하는가?
- [ ] `raw_webhooks.idempotency_key`로 중복 체크하는가?
- [ ] 중복 시 로그만 남기고 무시하는가?
- [ ] 리마인더 발송 시 `reminder_logs`로 중복 체크하는가?

## 시트 연동
- [ ] GAS에서 헤더 이름으로 매핑해서 JSON 전송하는가?
- [ ] 시트 컬럼 순서 변경해도 파싱이 깨지지 않는가?

## 데이터 수신
- [ ] 구글시트에서 데이터가 들어오면 저장되는가?
- [ ] 발송 실패 시 관리자에게 문자가 가는가?
- [ ] 분석 실패 시 인박스로 이동하는가?
- [ ] 슬롯 충돌 시 인박스로 이동하는가?
- [ ] 슬롯 충돌 시 관리자에게 알림이 가는가?

## 환불 자동 처리
- [ ] "결제 취소" 데이터 감지가 되는가?
- [ ] 전화번호+슬롯으로 세션 매칭이 되는가?
- [ ] 매칭 성공 시 자동 REFUNDED 처리가 되는가?
- [ ] 매칭 실패 시 인박스로 이동하는가?
- [ ] 환불 시 취소사유가 저장되는가?
- [ ] 환불 시 관리자에게 알림이 가는가?

## 날짜 계산
- [ ] 신규 등록 시 "다음 주 해당 요일"로 시작되는가? (KST 기준)
- [ ] 재결제 시 기존 종료일 다음날부터 시작되는가?
- [ ] 수강 연기 시 종료일이 늘어나는가?

## 자동 실행 (크론잡)
- [ ] 매일 0시 5분 (KST)에 PENDING → ACTIVE 전환이 되는가?
- [ ] 매일 0시 10분 (KST)에 ACTIVE → EXPIRED 전환이 되는가?
- [ ] 매일 오후 6시 (KST)에 리마인더가 발송되는가?

## 문자 발송
- [ ] 문자 발송에 5초 타임아웃이 적용되었는가?
- [ ] 타임아웃 시 sms_logs에 실패 기록이 되는가?
- [ ] `provider_message_id`가 저장되는가?
- [ ] 실패한 문자를 재시도할 수 있는가?

## 취소
- [ ] 취소하면 슬롯이 자동으로 비워지는가?
- [ ] 취소하면 관리자에게 알림이 가는가?
- [ ] 취소 시 확인창이 뜨고 사유를 입력해야 하는가?

## 대시보드
- [ ] 오늘의 수업이 표시되는가? (KST 기준 오늘)
- [ ] KPI 카드 숫자가 정확한가?
- [ ] 실시간으로 데이터가 갱신되는가? (Supabase Realtime)
- [ ] 인박스 항목이 표시되는가?
- [ ] 인박스에 "환불 매칭 실패" 타입이 표시되는가?
- [ ] 인박스 [처리완료] [무시] 버튼이 동작하는가?
- [ ] 인박스 [재처리] 버튼이 동작하는가?

## 메시지 대시보드
- [ ] 모든 로그가 실시간으로 보이는가?
- [ ] 날짜 필터가 동작하는가? (오늘/어제/최근7일/날짜선택)
- [ ] 상태 필터가 동작하는가? (전체/미처리/처리완료)
- [ ] 오류만 필터가 동작하는가?
- [ ] 로그 상세 보기(펼치기)가 동작하는가?
- [ ] 원본 데이터가 표시되는가?
- [ ] [재시도] 버튼이 동작하는가? (문자 발송)
- [ ] [재처리] 버튼이 동작하는가? (웹훅 원본)
- [ ] [처리완료] [무시] 버튼이 동작하는가?

## 코치 화면
- [ ] 코치 목록이 보이는가?
- [ ] 슬롯 0개 코치가 아래로 정렬되는가?
- [ ] 코치 추가 시 전화번호 중복이면 알림이 뜨는가?
- [ ] 슬롯 필터 (전체/진행중/종료예정/빈슬롯)가 동작하는가?
- [ ] 슬롯 추가/수정/비활성화가 되는가?
- [ ] 빈 슬롯 삭제가 되는가?
- [ ] 슬롯 시간 수정 시 히스토리에 기록되는가?
- [ ] 오픈톡 링크 복사가 되는가?
- [ ] 연장 권유 문자 발송 버튼이 동작하는가?
- [ ] 캘린더에 수업 날짜가 표시되는가?
- [ ] 캘린더에 연기된 날짜가 다르게 표시되는가?
- [ ] 이번 달 코칭 횟수가 연기 제외하고 계산되는가?

## 수강생 화면
- [ ] 펼쳐지는 형식으로 상세 정보가 보이는가?
- [ ] 이름/전화번호로 검색이 되는가?
- [ ] 정렬 옵션이 동작하는가? (종료임박순/등록일순/이름순/코치별)
- [ ] 상태 필터가 동작하는가? (전체/수강중/대기/종료예정/종료/환불취소)
- [ ] 연장 횟수가 표시되는가? (예: "3회차 수강")
- [ ] 남은 수업 횟수가 표시되는가? (예: "4회 중 2회 완료")
- [ ] 결제 정보가 표시되는가? (금액, 결제일, 상품명)
- [ ] 과거 세션이 전체 표시되는가?
- [ ] 히스토리가 시간순으로 보이는가?
- [ ] 변경 이력이 보이는가?
- [ ] 수강 연기 기능이 동작하는가? (1주/2주/3주 선택)
- [ ] 환불된 수강생에 취소사유가 표시되는가?
- [ ] 조기종료 상태(🔸)가 표시되는가?
- [ ] [수강생 추가] 버튼이 동작하는가?
- [ ] 수동등록된 수강생에 (수동등록) 표시가 나오는가?
- [ ] 수동등록 시 히스토리에 사유가 기록되는가?
- [ ] [병합] 버튼이 동작하는가?
- [ ] 병합 시 세션이 올바르게 이동되는가?
- [ ] 병합 후 히스토리에 기록되는가?
- [ ] 수강생 상태가 세션 기준으로 자동 표시되는가?

## 정산
- [ ] 월별 선택 (이전/다음 달 이동)이 되는가?
- [ ] 코칭 횟수가 맞게 계산되는가?
- [ ] 연기한 날짜가 제외되는가?
- [ ] 환불일 이후가 제외되는가?
- [ ] 조기종료일 이후가 제외되는가?
- [ ] 월 경계 세션이 정확히 분리되는가?
- [ ] 등급별 단가가 맞게 적용되는가? (견습 4만, 일반 5만, 선임 7.5만)
- [ ] 정산 화면이 읽기 전용인가? (수정 버튼 없음)
- [ ] 코치 지급 합계가 표시되는가?
- [ ] 월 매출이 표시되는가? (코칭 횟수 × 1회 매출)
- [ ] 회사 수익이 표시되는가? (매출 - 코치 지급)
- [ ] [정산 확정] 버튼이 동작하는가?
- [ ] 확정된 월에 "✅ 확정됨" 표시가 나오는가?
- [ ] [확정 취소] 버튼이 동작하는가?
- [ ] 확정된 월의 세션 수정 시 경고창이 뜨는가?

## 슬롯 시간 변경
- [ ] 슬롯 시간 수정이 가능한가?
- [ ] 수강생 있어도 시간 수정 가능한가?
- [ ] 히스토리에 SLOT_TIME_CHANGE가 기록되는가?
- [ ] 수강생/코치에게 알림이 가는가?

## 연기
- [ ] 연기 시 postponements 테이블에 날짜가 기록되는가?
- [ ] 히스토리에 POSTPONE이 기록되는가?
- [ ] 정산에서 연기한 날짜가 제외되는가?
- [ ] 1주/2주/3주 선택 UI가 동작하는가?

## 수강생 병합
- [ ] 수강생 병합이 동작하는가?
- [ ] 세션이 올바르게 이동되는가?
- [ ] 병합 대상 수강생이 삭제되는가?
- [ ] 히스토리에 USER_MERGE가 기록되는가?

## 안전장치
- [ ] 위험한 동작에 확인창이 뜨는가?
- [ ] 날짜 수정 시 전/후 비교가 표시되는가?
- [ ] 수강생 있는 슬롯은 비활성화가 막히는가?
- [ ] 수강생 병합 시 경고가 표시되는가?

## constants.ts 동기화
- [ ] 모든 상태값이 constants.ts에 정의되어 있는가?
- [ ] TIMEZONE이 'Asia/Seoul'로 정의되어 있는가?
- [ ] API_CONFIG.SMS_TIMEOUT_MS가 5000으로 정의되어 있는가?
- [ ] COACH_SETTLEMENT가 정의되어 있는가? (revenuePerSession, companyPerSession 포함)
- [ ] 코드에서 문자열 직접 사용 없이 constants를 import해서 쓰는가?
- [ ] ⚠️ constants 변경 시 DB CHECK 제약도 같이 변경했는가?

---

# 📌 13. 작업 리스트 (추후 진행)

| 항목 | 설명 | 우선순위 |
|------|------|----------|
| 연장 권유 문자 내용 | 문자 템플릿 작성 | 🔴 높음 |
| 문자 템플릿 관리 화면 | 각 상황별 문자 내용 설정 기능 | 🟡 중간 |
| 코치 휴무 기능 | 코치 휴가 시 휴강 처리 + 정산 반영 | 🟡 중간 |
| **관리자 로그인** | Supabase Auth로 인증 추가 | 🟡 중간 |
| 데이터 내보내기 | 엑셀 다운로드 기능 | 🟢 낮음 |

---

# 📌 14. 용어 설명

| 용어 | 쉬운 설명 |
|------|-----------|
| 슬롯 | 코치가 열어둔 수업 시간대 (예: 화요일 19시) |
| 세션 | 수강생이 구매한 4주 수업 기간 |
| 파싱 | 텍스트 데이터를 분석해서 정보 추출하는 것 |
| 인박스 | 자동 처리 실패한 데이터 보관함 |
| 슬롯 충돌 | 이미 사용 중인 슬롯에 다른 수강생을 배정하려고 할 때 |
| 환불 매칭 | "결제 취소" 데이터를 기존 세션과 연결하는 것 |
| 크론잡 | 정해진 시간에 자동으로 실행되는 작업 |
| KST | 한국 표준시 (Asia/Seoul, UTC+9) |
| UTC | 세계 협정시 (영국 기준, 한국보다 9시간 느림) |
| 타임아웃 | 응답을 기다리는 최대 시간 (초과 시 실패 처리) |
| **멱등성** | 같은 요청을 여러 번 해도 결과가 1번만 적용되는 것 |
| **멱등키** | 중복 요청을 구분하기 위한 고유 식별자 |
| RPC | 데이터베이스에서 여러 작업을 한 번에 처리하는 기능 |
| API | 서버와 통신하는 방법 |
| 정산 | 코치별 월간 코칭 횟수 × 등급별 단가 계산 |
| constants | 코드에서 사용하는 고정된 값들을 모아둔 파일 |
| Latpeed | 결제 플랫폼 (결제/환불 처리) |
| dayjs | 날짜/시간 처리 라이브러리 |
| TIME | 시간만 저장하는 DB 타입 (예: 19:00:00) |
| **조기종료** | 환불 등으로 세션이 원래 종료일 전에 끝나는 것 |
| **연기** | 특정 날짜의 수업을 쉬는 것 (정산에서 제외) |
| **정산 확정** | 해당 월 정산 완료 후 잠금 (수정 시 경고) |
| **수동등록** | 시트 거치지 않고 웹에서 직접 수강생 추가 |
| **수강생 병합** | 중복 등록된 수강생을 하나로 합치는 기능 |

---

*문서 끝 - v3.13*
